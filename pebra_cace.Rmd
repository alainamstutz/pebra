---
title: "PEBRA Complier Average Causal Effect Analyses"
author: "A.Amstutz"
date: "2023-05-07"
output:
  html_document:
    keep_md: yes
    toc: yes
    toc_float: yes
    code_folding: hide
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r load packages, include=FALSE}
library(tidyverse)
library(readxl)
library(tableone)
library(data.table)
library(writexl)
library(lme4)
library(msm)

```

```{r load data, include=FALSE}
enrolment <- read_excel("data/0m_enrolment.xls")
twelve_month <- read_excel("data/12m_status_VL_ART_20210505.xls")
baseline_VL <- read_excel("data/0m_VL_2xlsx.xls")
# all intervention peer educators
pe_1 <- read_excel("data/cheezy_pa.xls")
pe_2 <- read_excel("data/itu_pa.xls")
pe_3 <- read_excel("data/johnnie_pa.xls")
pe_4 <- read_excel("data/leekay_pa.xls")
pe_5 <- read_excel("data/luciah_pa.xls")
pe_6 <- read_excel("data/mc_pa.xls")
pe_7 <- read_excel("data/more1_pa.xls")
pe_8 <- read_excel("data/nono_pa.xls")
pe_9 <- read_excel("data/sk_pa.xls")
pe_10 <- read_excel("data/tlikso_pa.xls")

```

```{r data management characteristics PAs, include=FALSE}
# merge pa's from different intervention clinics
all_pa <- bind_rows(pe_1,pe_2,pe_3,pe_4,pe_4,pe_5,pe_6,pe_7,pe_8,pe_9,pe_10)

# delete duplicates

# all_pa_cleaned <- c()
# noduplicates_frame <- c()
# 
# ## all rows from unique ID
# for (j in unique(all_pa$IND_ID)){
#   ## safe in temporary df
#   noduplicates_frame <- all_pa[which(all_pa$IND_ID==j),]
#   ## order df by date
#   noduplicates_frame <- noduplicates_frame[order(noduplicates_frame$DATE_CREATED),]
#   if (nrow(noduplicates_frame) > 1) {
#     ## every row in df
#     for (rec in (nrow(noduplicates_frame)-1):1) {
#       ## compare with next to follow
#       if (noduplicates_frame$DATE_CREATED [rec] == noduplicates_frame$DATE_CREATED [rec+1]){
#         ## if they have an identical date, delete first row
#         noduplicates_frame <- noduplicates_frame [-rec,]
#       }
#     }
#   }
#   ## merge data frames from single patients into one df again
#   all_pa_cleaned <- bind_rows(all_pa_cleaned, noduplicates_frame)
# }
# all_pa <- all_pa_cleaned

# delete duplicates
all_pa <- all_pa %>% 
  distinct()

# # # recode all true and false (and NA) to numeric
# all_pa[all_pa == "true"] <- 1
# all_pa[all_pa == "false"] <- 2
# all_pa[is.na(all_pa)] <- 0

# replace refill with SCC if ART Refill = 1 (clinic) and SUPPORT SCC = true (= SCC wished and available)
table(all_pa$SUPPORT_SCC, useNA = "always")
class(all_pa$SUPPORT_SCC)

table(all_pa$ART_REFILL_1, useNA = "always")
class(all_pa$ART_REFILL_1)

all_pa <- all_pa %>%
  mutate(ART_REFILL_1 = case_when(SUPPORT_SCC == "true" & ART_REFILL_1 == "1" ~ "6",
                                   TRUE ~ c(ART_REFILL_1)))

```

```{r data management preference data, include=FALSE}
# Add enrollment date
all_pa <- merge(all_pa, enrolment[, c("DATE_ENROL", "IND_ID")], by = "IND_ID")

# Preference assessment per ID
unique(all_pa$IND_ID)
all_pa %>%
  summarise(median = median(table(IND_ID)),
            IQR = IQR(table(IND_ID)),
            Q1 = quantile(table(IND_ID), probs = 0.25),
            Q3 = quantile(table(IND_ID), probs = 0.75))

## sort our first, middle and last assessment of each patient
start_pa <- data.frame()
end_pa <- data.frame()
mid_pa <- data.frame()

# loop all PAs by participant
for (j in unique(all_pa$IND_ID)){
  # put all assessments of patient in one df
  id_frame <- all_pa[which(all_pa$IND_ID==j),]
  # order df by assessment date
  id_frame <- id_frame[order(id_frame$DATE_CREATED),]
  # START PA: safe first row = first assessment of patient in new df
  start_id_frame <- head(id_frame, n=1)
  colnames(start_id_frame) <- paste0(colnames(start_id_frame),"_start")
  # MID PA: between 5 and 7 months from first assessment
  mid_id_new <- id_frame[as.Date(id_frame$DATE_CREATED) < (as.Date(id_frame$DATE_CREATED[1]) + months(7)),]
  mid_id_new <- id_frame[as.Date(id_frame$DATE_CREATED) >= (as.Date(id_frame$DATE_CREATED[1]) + months(5)),]
  # chose first option if there is multiple
  mid_id_frame <- head(mid_id_new, n=1)
  colnames(mid_id_frame) <- paste0(colnames(mid_id_frame),"_mid")
  # LAST PA: safe last row = last assessment of patient in new df
  end_id_frame <- tail(id_frame, n=1)
  colnames(end_id_frame) <- paste0(colnames(end_id_frame),"_end")
  # bind first assessments from all patients to new df
  start_pa <- bind_rows(start_pa, start_id_frame)
  # bind middle assessments from all patients to new df
  mid_pa <- bind_rows(mid_pa, mid_id_frame)
  # bind last assessments from all patients to new df
  end_pa <- bind_rows(end_pa, end_id_frame)
}

start_pa <- start_pa %>% 
  select(IND_ID_start, PE_start, ID_start, DATE_CREATED_start, TIME_CREATED_start, DATE_ENROL_start, everything())
end_pa <- end_pa %>% 
  select(IND_ID_end, PE_end, ID_end, DATE_CREATED_end, TIME_CREATED_end, DATE_ENROL_end, everything())
mid_pa <- mid_pa %>% 
  select(IND_ID_mid, PE_mid, ID_mid, DATE_CREATED_mid, TIME_CREATED_mid, DATE_ENROL_mid, everything())

# tableone <- tableone::CreateTableOne(data = start_pa,vars = start_pa_vars[!start_pa_vars == "GENDER"],strata = "GENDER",includeNA = TRUE,test = FALSE,addOverall = TRUE)
# 
# capture.output(tableone <- print(tableone, nonnormal = start_pa_vars,catDigits = 1,SMD = TRUE,showAllLevels = TRUE,test = FALSE,printToggle = FALSE,missing = FALSE))
#
# #print
# knitr::kable(tableone,caption = "Baseline assessment of Notifications, missing values in categorical variables: NAs")

```

```{r work with baseline PA, include=FALSE}
# rename variables that we don't want to be double
start_pa <- start_pa %>% 
  rename(IND_ID = IND_ID_start)

# Unpack Support Option String
class(start_pa$SUPPORT_start)
unique(start_pa$SUPPORT_start)
table(start_pa$SUPPORT_start)
# library(stringr)
# start_pa$SUPPORT_start2 <- strsplit(start_pa$SUPPORT_start, ", ")
# class(start_pa$SUPPORT_start2)

start_pa <- start_pa %>% ## classify nurse support only as No, everyone else chose some pe support
  mutate(pe_support = case_when(grepl("1", SUPPORT_start) == TRUE & 
                                  grepl("2", SUPPORT_start) == FALSE & 
                                  grepl("3", SUPPORT_start) == FALSE &
                                  grepl("4", SUPPORT_start) == FALSE &
                                  grepl("5", SUPPORT_start) == FALSE &
                                  grepl("6", SUPPORT_start) == FALSE &
                                  grepl("7", SUPPORT_start) == FALSE &
                                  grepl("8", SUPPORT_start) == FALSE &
                                  grepl("9", SUPPORT_start) == FALSE &
                                  grepl("10", SUPPORT_start) == FALSE &
                                  grepl("11", SUPPORT_start) == FALSE &
                                  grepl("12", SUPPORT_start) == FALSE &
                                  grepl("13", SUPPORT_start) == FALSE &
                                  grepl("14", SUPPORT_start) == FALSE ~ "No",
                             TRUE ~ "Yes"))
start_pa %>% ## reclassify the one who wanted no support at all as "nurse support only" / "no PE support"
  mutate(pe_support = case_when(grepl("14", SUPPORT_start) == TRUE ~ "No",
                             TRUE ~ c(pe_support)))

table(start_pa$pe_support, useNA = "always")

# what to do with those that chose nurse + those on-the-spot options such as cds demo? -> for now leave them in PE support

```

```{r prepare entire dataset for ITT analysis, message=FALSE, include=FALSE}
# Add preference assessment data of baseline
df <- left_join(enrolment, start_pa[, c("pe_support", "IND_ID")], by = join_by(IND_ID == IND_ID))
table(df$pe_support, useNA = "always")

# Add 12m data
twelve_month <- twelve_month %>% 
  rename(CurrentARTregimen_end = CurrentARTregimen,
         CurrentARTregimen_other_end = CurrentARTregimen_other,
         CurrentARTregimen_SINCE_WHEN_end = CurrentARTregimen_SINCE_WHEN)
df <- left_join(df, twelve_month[, c("CurrentARTregimen_end", "CurrentARTregimen_other_end", "CurrentARTregimen_SINCE_WHEN_end",
                                            "DATE_CREATED_REFILL", "DATE_NEXT", "REFILL_TYPE", "REFILL_NO", "DEATH_DATE", "DEATH_CAUSE",
                                            "HOSP", "TRANSFER_TO", "TRANSFER_DATE", "ART_STOP", "STATUS", "STATUS_DETAIL", "VL_DATE",
                                            "FAILED", "VL_LTDL", "VL_RESULT", "IND_ID")], by = join_by(IND_ID == IND_ID))
# Add baseline VL
baseline_VL <- baseline_VL %>% 
  rename(VL_LTDL_baseline = VL_LTDL,
         VL_RESULT_baseline = VL_RESULT)
df <- left_join(df, baseline_VL[, c("VL_LTDL_baseline", "VL_RESULT_baseline", "IND_ID")], by = join_by(IND_ID == IND_ID))

# # reclassify the confirmed transfer out as "out of care"
# class(df$STATUS)
# df <- df %>% 
#   mutate(STATUS = case_when(STATUS == "in care" & STATUS_DETAIL == "transfer" ~ "out of care",
#                             TRUE ~ c(STATUS)))

# gender
table(df$GENDER)
df$GENDER <- ifelse(as.numeric(df$GENDER) == 1,"female","male")

# cell phone
table(df$CELL_GIVEN)
df$CELL_GIVEN <- sapply(df$CELL_GIVEN,FUN = function(a){
  if (a == 1){return("Yes")}
  if (a %in% c(2,3)){return("No")}
})

# age at day of enrolment
df$AGE <- as.numeric(difftime(df$DATE_ENROL,df$BIRTHDAY,units = "weeks")/52.143)

# sexual orientation
table(df$SEX_ORIENT)
df$SEX_ORIENT <- sapply(df$SEX_ORIENT,FUN = function(a){
  if (a == 1){return("straight or heterosexual")}
  if (a == 3){return("gay or lesbian")}
  if (a == 4){return("prefer not to answer")}
})

# completed years of school
df$N_school <- with(df,as.numeric(primary)+as.numeric(secondary)+as.numeric(tertiary)+as.numeric(high_school))

# no schooling at all
df$no_schooling <- ifelse(df$N_school == 0,"Yes","No")

# employment
df$employment_yn <- ifelse(df$emplyoment %in% c("No regular income / unemployed","Subsistence farming","Housewife"),yes = "unemp",no = "emp")

# occupation
df$occupation <- mapply(FUN=function(employment,currently_attending){
  if (employment == "unemp" & currently_attending == "Yes"){return("attending school")}
  if (employment == "emp"){return("(self-)employed")}
  if (employment == "unemp" & currently_attending == "No"){return("nothing")}
},df$employment_yn,df$currently_attending)

# profession
table(df$profession)
tab <- table(df$profession)<3
df$profession <- ifelse(df$profession %in% c(names(tab[tab]),"Other"),"Other",df$profession)

# pregnant or breastfeeding
df$pregnant_breastfeeding <- sapply(xor(df$Pregnant == "Yes",df$Breastfeeding == "Yes"),FUN = function(a){
  if (is.na(a)){return(NA)}
  else if (a == TRUE){return("Yes")}
  else if (a == FALSE){return("No")}
})
df$pregnant_breastfeeding[df$GENDER=="male"]<-NA
df$pregnant_breastfeeding[df$GENDER=="female" & is.na(df$pregnant_breastfeeding)]<- "No"
table(df$pregnant_breastfeeding, df$GENDER, useNA = "always")

# contraceptive use
# sterilized : 0
table(df$fp_other)
df$fp_inject[which(df$fp_other==1)]<-1
df$fp_other[which(df$fp_other==1)]<-0
df$fp_calendar <- ifelse(as.numeric(df$fp_calendar)==1,"Yes","No")
df$fp_condom <- ifelse(as.numeric(df$fp_condom) ==1,"Yes","No")
df$fp_pill <- ifelse(as.numeric(df$fp_pill) ==1,"Yes","No")
df$fp_withdraw <- ifelse(as.numeric(df$fp_withdraw)==1,"Yes","No")
df$fp_inject <- ifelse(as.numeric(df$fp_inject)==1,"Yes","No")
df$fp_other <- ifelse(as.numeric(df$fp_other)==1,"Yes","No")
df$fp_no_answer <- ifelse(as.numeric(df$fp_no_answer)==1,"Yes","No")

# how many children (add 0 if NA)
df$Howmany[is.na(df$Howmany)] <- 0

# number of correctly answered HIV knowledge questions
df$N_HIV_question <- with(df,mapply(FUN = sum,kissing == "No",kitchen == "No",touching == "No",men_to_women == "Yes",women_to_men == "Yes",partners == "No",washing == "No",pregnant_to_baby == "Yes",virgin == "No",cure == "No"))

# expenses
df$expenses_transport_yn <- sapply(df$expenses_transport, FUN = function(a){
  if(a == "1"){return("yes")}
  else {return("no")}
    })
df$expenses_transport_cost <- as.numeric(df$expenses_transport_cost)
df$expenses_food_yn <- sapply(df$expenses_food, FUN = function(a){
  if(a == "1"){return("yes")}
  else {return("no")}
    })
df$expenses_food_cost <- as.numeric(df$expenses_food_cost)

# marital status
table(df$Maritalstatus)
df$Maritalstatus <- ifelse(df$Maritalstatus %in% c("divorced","separated","widowed"),"div/sep/wid",df$Maritalstatus)

```

# Baseline characteristics by group: socio-demographics

```{r sociodemographic table, echo=TRUE}
# table for sociodemographic characteristics
vars.list <- c("ARM","GENDER","AGE","CELL_GIVEN","SEX_ORIENT","currently_attending","no_schooling","N_school","emplyoment","occupation","profession","Maritalstatus","pregnant_breastfeeding","Howmany","using_fp","fp_condom","fp_pill","fp_inject","fp_withdraw","fp_calendar","fp_other","fp_no_answer","N_HIV_question","expenses_transport_yn","expenses_transport_cost","expenses_food_yn","expenses_food_cost")

df_sociodemo <- df[,colnames(df)%in%vars.list]
df_sociodemo <- df_sociodemo[,match(vars.list,colnames(df_sociodemo))]
colnames(df_sociodemo) <- vars.list <- c("ARM","Gender","Age at enrolment","Cell phone to receive confidential information","Sexual orientation","Currently attending school","No schooling","Number of completed school years","Employment","Occupation","Profession (if (self-)employed)","Marital status","Pregnant  or breastfeeding","Number of children","Contraception use","Contraception: Condom use (male and female)","Contraception: Contraceptive pill","Contraception: Injectable or Implant (e.g. DEPO)","Contraception: Withdraw","Contraception: Calendar method","Contraception: other","Contraception: no answer","Number of correctly answered HIV knowledge questions (maximum 10)","Expenses: transport","Expenses: transport costs","Expenses: food","Expenses: food costs")

table_sociodemo <- tableone::CreateTableOne(data = df_sociodemo,vars = vars.list[!vars.list == "ARM"],strata = "ARM",includeNA = TRUE,test = FALSE,addOverall = TRUE)

capture.output(table_sociodemo <- print(table_sociodemo, nonnormal = vars.list,catDigits = 1,SMD = TRUE,showAllLevels = TRUE,test = FALSE,printToggle = FALSE,missing = TRUE))

#print
knitr::kable(table_sociodemo,caption = "Baseline characteristics: socio-demographic, missing values in categorical variables: NAs")

```

# Baseline characteristics by group: clinical

```{r include=FALSE}
# year of HIV diagnosis
df$diagnosis_year_cat <- sapply(df$DateofHIVdiagnosis,FUN=function(a){
  a <- as.Date(a)
  if (a >= as.Date("2005-01-01") & a < as.Date("2010-01-01")){return("2005-2009")}
  if (a >= as.Date("2010-01-01") & a < as.Date("2015-01-01")){return("2010-2014")}
  if (a >= as.Date("2015-01-01") & a < as.Date("2020-01-01")){return("2015-2020")}
})
df$time_diag_enrol <- as.numeric(difftime(df$DATE_ENROL,df$DateofHIVdiagnosis,units = "weeks")/52.14)

# year of ART start
df$artstart_year_cat <- sapply(df$art_start_date,FUN=function(a){
  a <- as.Date(a)
  if (a >= as.Date("2005-01-01") & a < as.Date("2010-01-01")){return("2005-2009")}
  if (a >= as.Date("2010-01-01") & a < as.Date("2015-01-01")){return("2010-2014")}
  if (a >= as.Date("2015-01-01") & a < as.Date("2020-01-01")){return("2015-2020")}
})
df$time_artstart_enrol <- as.numeric(difftime(df$DATE_ENROL,df$art_start_date,units = "weeks")/52.14)

# year of HIV infection
df$infection_year_cat <- sapply(df$infection_year,FUN=function(a){
  a <- as.Date(a)
  if (a >= as.Date("1995-01-01") & a < as.Date("2000-01-01")){return("1995-1999")}
  if (a >= as.Date("2000-01-01") & a < as.Date("2005-01-01")){return("2000-2004")}
  if (a >= as.Date("2005-01-01") & a < as.Date("2010-01-01")){return("2005-2009")}
  if (a >= as.Date("2010-01-01") & a < as.Date("2015-01-01")){return("2010-2014")}
  if (a >= as.Date("2015-01-01") & a < as.Date("2020-01-01")){return("2015-2020")}
})
df$time_infection_enrol <- as.numeric(difftime(df$DATE_ENROL,df$infection_year,units = "weeks")/52.14)

# current ART regimen
table(df$CurrentARTregimen,useNA = "always")
table(df$CurrentARTregimen_other, useNA = "always")
df$CurrentARTregimen[df$CurrentARTregimen == "ABC/3TC/Kaletra(LPV/r)"] <- "ABC/3TC/LPV/r"
df$CurrentARTregimen[df$CurrentARTregimen == "TDF/3TC/Kaletra(LPV/r)"] <- "TDF/3TC/LPV/r"
df$CurrentARTregimen[df$CurrentARTregimen == "TDF/3TC/DTG (=TLD)"] <- "TDF/3TC/DTG"
df$CurrentARTregimen[df$CurrentARTregimen == "other"] <- df$CurrentARTregimen_other[df$CurrentARTregimen == "other"]
df <- df %>% 
  mutate(CurrentARTregimen = case_when(CurrentARTregimen == "ABC 3TC DTG" ~ "ABC/3TC/DTG",
                                       CurrentARTregimen == "AZT 3TC DTG" ~ "AZT/3TC/DTG",
                                       TRUE ~ CurrentARTregimen))

df$CurrentARTregimen[grepl("EFV",df$CurrentARTregimen)] <- "EFV-based"
df$CurrentARTregimen[grepl("NVP",df$CurrentARTregimen)] <- "NVP-based"
df$CurrentARTregimen[grepl("LPV/r",df$CurrentARTregimen)] <- "LPV/r-based"
df$CurrentARTregimen[grepl("DTG",df$CurrentARTregimen)] <- "DTG-based"

# ART regimen at endpoint
table(df$CurrentARTregimen_end,useNA = "always")
table(df$CurrentARTregimen_other_end, useNA = "always")
df$CurrentARTregimen_end[df$CurrentARTregimen_end == "ABC/3TC/Kaletra(LPV/r)"] <- "ABC/3TC/LPV/r"
df$CurrentARTregimen_end[df$CurrentARTregimen_end == "TDF/3TC/Kaletra(LPV/r)"] <- "TDF/3TC/LPV/r"
df$CurrentARTregimen_end[df$CurrentARTregimen_end == "TDF/3TC/DTG (=TLD)"] <- "TDF/3TC/DTG"
df <- df %>% 
  mutate(CurrentARTregimen_end = case_when(CurrentARTregimen_end == "other" ~ "ETV/3TC/LPV/r (3rd line)",
                                       TRUE ~ CurrentARTregimen_end))

df$CurrentARTregimen_end[grepl("EFV",df$CurrentARTregimen_end)] <- "EFV-based"
df$CurrentARTregimen_end[grepl("NVP",df$CurrentARTregimen_end)] <- "NVP-based"
df$CurrentARTregimen_end[grepl("LPV/r",df$CurrentARTregimen_end)] <- "LPV/r-based"
df$CurrentARTregimen_end[grepl("DTG",df$CurrentARTregimen_end)] <- "DTG-based"

#cd4 at art start
df$cd4_start_cat <- factor(sapply(as.numeric(df$cd4_start),FUN = function(a){
  if(is.na(a)) {return(NA)}
  else if (a < 200) {return("<200")}
  else if (a >= 500) {return(">499")}
  else {return("200-499")}
}))

df$cd4_start_cat <- relevel(df$cd4_start_cat,ref = "200-499")
df$cd4_start_cat <- relevel(df$cd4_start_cat,ref = "<200")

#baseline viral load
table(df$VL_LTDL_baseline, df$VL_RESULT_baseline, useNA = "always")

df$baseline_Vl_cat <- factor(sapply(df$VL_RESULT_baseline, FUN = function(a){
  a <- as.numeric(a)
  if (is.na(a)){return(NA)}
  else if (a < 20){return("<20")}
  else if (a >= 20 & a <1000){return("20-999")}
  else if (a>=1000){return(">999")}
}))
table(df$baseline_Vl_cat, useNA = "always")
df$baseline_Vl_cat <- relevel(df$baseline_Vl_cat,ref="20-999")
df$baseline_Vl_cat <- relevel(df$baseline_Vl_cat,ref="<20")

# Add transmission way
table(df$infection_way, useNA = "always")
class(df$infection_way)
df <- df %>% 
  mutate(infection_mode = case_when(infection_way == "Through my mother" ~ "vertical",
                                    infection_way == "Blood products" | infection_way == "Sex with a man" 
                                    | infection_way == "Sex with a woman" | infection_way == "Other" ~ "horizontal",
                                    TRUE ~ c(infection_way)))
table(df$infection_mode, useNA = "always")
table(df$infection_way_other, useNA = "always")

```

```{r clinical table, echo=TRUE}
# table for clinical characteristics
vars.list <- c("diagnosis_year_cat","time_diag_enrol","artstart_year_cat",
                   "time_artstart_enrol","infection_year_cat","time_infection_enrol",
                   "CurrentARTregimen","Currently_TBx","cd4_start_cat",
                   "baseline_Vl_cat","infection_way","ARM")

df_clinical <- df[,colnames(df)%in%vars.list]
df_clinical <- df_clinical[,match(vars.list,colnames(df_clinical))]

colnames(df_clinical) <- vars.list <- c("Year of HIV diagnosis","Years since HIV diagnosis","Year of starting ART","Years since starting ART","Year of HIV infection","Years since HIV infection","Current ART regimen","Currently on TB treatment","CD4 count at ART start", "Baseline viral load","How do you believe you were infected with HIV?","ARM")

table_clinical <- tableone::CreateTableOne(data = df_clinical,vars = vars.list[!vars.list == "ARM"],strata = "ARM",includeNA = TRUE,test = FALSE,addOverall = TRUE)

capture.output(table_clinical <- print(table_clinical, nonnormal = vars.list,catDigits = 1,SMD = TRUE,showAllLevels = TRUE,test = FALSE,printToggle = FALSE,missing = TRUE))

#print
knitr::kable(table_clinical,caption = "Baseline characteristics: clinical, missing values in categorical variables: NAs")

```

# Primary endpoint

The primary outcome of the trial is:

In care with documented viral suppression at 12 months, defined as the proportion of participants in care with a documented VL \<20 copies/mL 12 months (range: 9 -- 15 months) after enrolment out of all participants enrolled

i.  If several viral loads are available in the primary endpoint window, then the result closest to the 12-months endpoint (date of enrolment + 365 days) will be considered.

ii. Rational for VL suppression level at 20 copies/mL: VL determination will be done on COBAS TaqMan HIV-1 Test, v2.0 (Roche Diagnostics) using plasma, and has a reliable lower limit of detection of 20 copies/mL

iii. Definition of "in care": at least one ART visit in the defined window

<!-- -->

I.  Participants who transferred out to any other health facility with known outcome are considered in care (documented proof VL within the primary endpoint window)

II. Participants who died (all-cause), were lost to follow-up (LTFU), or were alive, not taking ART anymore are considered out of care. We define participants lost to follow-up if they or their treatment buddies were more than 2 months late for a scheduled consultation or medication pick-up and no information was found about the participant. We define participants alive, not taking ART anymore if they were more than 2 months late for ART refill with a reason available (e.g. currently no money for clinic-visit, busy working in South Africa, known refusers, known defaulters, etc.)

<!-- -->

iv. The study will use VL results from routine VL monitoring. To synchronize routine VL monitoring and study VL monitoring, study staff will help ensure each site has the capacity to collect these samples and will support existing systems that help to provide results back to sites. VLs will only be performed on individuals who return for visits and no tracking besides standard of care will be performed by the study staff to obtain VLs.

```{r,echo = FALSE,results='markup'}
# endpoint definition
class(df$VL_DATE)
df$VL_DATE <- as.Date(df$VL_DATE)
df$VL_RESULT <- as.numeric(df$VL_RESULT)

# endpoint window (9-15)
df$endpoint_l <- as.Date(df$DATE_ENROL) + 252
df$endpoint_u <- as.Date(df$DATE_ENROL) + 450

# definition endpoint
fun_endpoint <- function(VL,VL_date,endpoint_l,endpoint_u,status){
  if (is.na(VL)){return(0)}
  else if (VL >= 20){return(0)}
  else if (status == "out of care"){return(0)}
  else if (xor(VL_date < endpoint_l,VL_date > endpoint_u)){return(0)}
  else {return(1)}}

df$endpoint_reached <- with(df,mapply(fun_endpoint,
  VL_RESULT,VL_DATE,endpoint_l,endpoint_u,STATUS))
table(df$endpoint_reached, useNA = "always")

```

### Endpoint overview

```{r,echo = FALSE,results='markup'}
tab <- percentage_table(df$endpoint_reached,df$ARM)
knitr::kable(tab,caption = "reached primary endpoint")


fun_endpoint_detail <- function(VL,VL_date,endpoint_l,endpoint_u,status){
  if (status == "out of care"){return("out of care")}
  else if (is.na(VL)){return("in care, VL missing")}
  else if (xor(VL_date < endpoint_l,VL_date > endpoint_u)){return("VL out of window")}
  else if (VL < 20){return("VL < 20")}
  else if (VL >= 20 && VL < 1000){return("VL 20-999")}
  else if (VL >= 1000){return("VL > 999")}}
  
df$endpoint_detail <- with(df,mapply(fun_endpoint_detail,
  VL_RESULT,VL_DATE,endpoint_l,endpoint_u,STATUS))

tab <- percentage_table(df$endpoint_detail,df$ARM)
tab <- tab[c(2,1,3,5,4,6),]

knitr::kable(tab,caption = "primary endpoint detail")

out_of_window <- df[df$endpoint_detail == "VL out of window",]
tab <- percentage_table(out_of_window$VL_RESULT<20,out_of_window$ARM)
rownames(tab) <- c(">=20","<20")
knitr::kable(tab,caption = "VLs of those out of window")

```

